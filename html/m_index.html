<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: "Trebuchet MS", "Helvetica", "Arial",  "Verdana", "sans-serif";
      font-size: 200%;
    }
    tr.border_bottom td {
      border-bottom:1pt solid black;
    }
  </style>    
  <title>NOSPO</title>  
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
</head>
<body>

<div id="main_div" style="width:100%; height:100%; text-align:center; margin:50px 0px 0px 0px;">
  <a href="//www.nospo.net"><img src="m_nospo_logo.png"><br></a>
  <input type="text" style="font-size : 65px;" id="id_002" placeholder=""><br>
  <h style="font-size : 45px;">Ex) 한화, LG트윈스, 20160401</h><br><br>
  <button id="id_000" style="font-size : 50px;" >Search</button>
  <div id="id_001" style="font-size : 35px; margin:50px 0px 0px 0px">
  </div>
</div>

<!-- Modal -->
<div id="dialog-confirm" title="Hmm..">
  Was it good?
  <span class='uuid' hidden='hidden'>abcd</span>
</div>

<script>
  $( "#dialog-confirm" ).dialog({
      autoOpen: false,
      resizable: true,
      height:350,
      width:800,
      modal: true,
      buttons: {
        "GOOD": function() {
          var uuid = $(this).children('.uuid').text();
          postGoodBadCnt(uuid, 'good');
          $( this ).dialog( "close" );
        },
        "BAD": function() {
          var uuid = $(this).children('.uuid').text();
          postGoodBadCnt(uuid, 'bad');
          $( this ).dialog( "close" );
        }
      }
  });

  $( "#id_000" ).click(function() {        
      req_data = $('#id_002').val();
      if (req_data.replace(/ /g,'') != ''){
        getSearch($('#id_002').val());  
      }else{
        $("#id_001").html(""); //remove old results.
      }
      $("#id_002").val('');
  });

  $("#id_002").keyup(function(){    
      req_data = $('#id_002').val();
      if (req_data.replace(/ /g,'') != ''){
        getSearch($('#id_002').val());  
      }else{
        $("#id_001").html(""); //remove old results.
      }
  });

  
  function getSearch(keyword_arg){  
    $.ajax({
      method: "GET",
      url: "/searchEngine?keyword="+keyword_arg,
      dataType: "json",
      success:function(data){
        
        $("#id_001").html(""); //remove old results.
        var table_painter = '<table style="width:100%"><colgroup><col span="1" style="width: 5%;"><col span="1" style="width: 25%;"><col span="1" style="width: 5%;"><col span="1" style="width: 25%;"><col span="1" style="width: 40%;"></colgroup>';
        
        $.each(data, function(index, value){
            if(value.url == "DNA"){
              $("#id_001").append(value.teamA+"&nbsp;<font color='Crimson'>VS</font>&nbsp;"+value.teamB+"&nbsp;<font color='Crimson'>On</font>&nbsp;"+value.dateTime+"&nbsp;<br>"); 
            }

          else if(value.url == "NEW"){
            $("#id_001").append(value.teamA+"&nbsp;<font color='Crimson'>VS</font>&nbsp;"+value.teamB+"&nbsp;<font color='Crimson'>On</font>&nbsp;"+value.dateTime+"&nbsp;<br>");            
            $("#id_001").append("<input id='newUrl' type='text' style='font-size : 50px;' placeholder='URL'></input>");
            $("#id_001").append("<a id='id_003' href='#' style='text-decoration: none'>&nbsp;Register!</a><br>");
            $('#id_003').on('click',function(){
              postReg(value.teamA,value.teamB,value.dateTime,$("#newUrl").val());
            });
          }

          else{
            if(Number(value.goodCnt) >= Number(value.badCnt) ){
              table_painter += "<tr class='border_bottom'>";
            }else{
              table_painter += "<tr>";
            }
            table_painter += "<td valign='top'><font size='5px'><b>Good:"+value.goodCnt+"<br>&nbsp;&nbsp;&nbsp;Bad:"+value.badCnt+"</b></font>&nbsp;</td>";
            table_painter += "<td>"+value.teamA+"</td><td>&nbsp;<font color='Crimson'>VS</font>&nbsp;</td><td>"+value.teamB+"&nbsp;</td>";
            table_painter += "<td valign='top'><span class='uuid' hidden='hidden'>"+value.uuid+"</span><font color='Crimson'>On</font>&nbsp;"+value.dateTime+"&nbsp;<br><a class='gogo' href='"+value.url+"' target='_blank' style='text-decoration: none'>Click Me!</a></td></tr>";
            if(Number(value.goodCnt) < Number(value.badCnt) ){
            table_painter += "<tr class='border_bottom'><td></td><td colspan='3'><input class='changedUrl' type='text' style='font-size : 50px;' placeholder='URL'></input></td>";
            table_painter += "<td colspan='2'><span class='uuid' hidden='hidden'>"+value.uuid+"</span><a class='gochange' href='#' style='text-decoration: none'>&nbsp;or Change!</a></td></tr>";
            }
          }

        });
        
        table_painter += "</table>";
        $("#id_001").append(table_painter);
        $('.gogo').on('click',function(){          
          var uuid = $(this).parent().children('.uuid').text();
          //console.log(uuid);
          $( "#dialog-confirm" ).children('.uuid').text(uuid);
          $( "#dialog-confirm" ).dialog( "open" );
        });
        $('.gochange').on('click',function(){
            var uuid2 = $(this).parent().children('.uuid').text();
            var url2 = ( $(this).parent() ).parent().find('.changedUrl').val();
            postGameUrl(uuid2,url2);
        });      
      },
      fail:function(receive){
        console.log('fail');
        console.log(receive);
      }
    });
  };

  function postReg(teamA,teamB,date,url){  
    $.ajax({
      method: "POST",      
      url: "/regNew",
      data: { "teamA" : teamA, "teamB": teamB, "date": date, "url": url },
      dataType: "json",
      success:function(data){
        $("#id_001").html(""); //remove old results.
        getSearch($('#id_002').val());        
      },
      fail:function(receive){
        console.log('fail');
        console.log(receive);
      }
    });
  };

  function postGoodBadCnt(uuid,goodBadFlg){
    $.ajax({
      method: "POST",      
      url: "/updateGoodBadCnt",
      data: { "uuid" : uuid, "goodBadFlg": goodBadFlg },
      dataType: "json",
      success:function(data){
        $("#id_001").html(""); //remove old results.
        getSearch($('#id_002').val());
      },
      fail:function(receive){
        console.log('fail');
        console.log(receive);
      }
    });
  };

  function postGameUrl(uuid,url){
    $.ajax({
      method: "POST",      
      url: "/updateGameUrl",
      data: { "uuid" : uuid, "url": url },
      dataType: "json",
      success:function(data){
        $("#id_001").html(""); //remove old results.
        getSearch($('#id_002').val());
      },
      fail:function(receive){
        console.log('fail');
        console.log(receive);
      }
    });
  };
</script>

</body>
</html>